# /webapps/erd-ecosystem/apps/pmbok/backend/Taskfile.yaml
version: '3'

# Variables de entorno por defecto para que Django arranque sin errores
env:
  # Forzamos modo DEBUG para evitar validaciones estrictas de seguridad en local
  DJANGO_DEBUG: "True"
  # Definimos una SECRET_KEY cualquiera para que settings.py no falle al arrancar
  SECRET_KEY: "insecure-test-key-for-task-runner"
  # Valores placeholder para la DB.
  # Aunque usemos SimpleTestCase, Django lee settings.py al inicio y necesita estos valores.
  # âœ… FIX: Alineado con docker-compose para que pueda conectar a la DB local
  DB_NAME: "pmbok_db"
  DB_USER: "pmbok_user"
  DB_PASSWORD: "secretpassword123"
  DB_HOST: "localhost"
  DB_PORT: "5432"

tasks:
  install:
    desc: "ðŸ“¦ Instalar dependencias (Local)"
    cmds:
      - poetry install --no-root

  install-ci:
    desc: "ðŸ“¦ Instalar dependencias (CI - Strict)"
    cmds:
      # --sync asegura que el entorno quede idÃ©ntico al lockfile (borra extra packages)
      - poetry install --no-root --sync

  test:
    desc: "ðŸ§ª Ejecutar pruebas unitarias (Pytest)"
    # Ejecuta los tests usando la configuraciÃ³n de pytest.ini
    cmds:
      - echo "ðŸ§ª [BACKEND] Ejecutando tests..."
      - poetry run pytest

  # âœ… NEW: EstandarizaciÃ³n de Linting
  lint:
    desc: "ðŸ§¹ Check de cÃ³digo (Flake8/Black)"
    cmds:
      - echo "ðŸ§¹ [BACKEND] Linting..."
      # Descomentar cuando configures linters:
      # - poetry run flake8 .
      # - poetry run black --check .

  # âœ… NEW: EstandarizaciÃ³n de Formateo
  fmt:
    desc: "ðŸŽ¨ Formatear cÃ³digo (Auto-fix)"
    cmds:
      - echo "ðŸŽ¨ [BACKEND] Formatting..."
      # - poetry run black .

  run:
    desc: "ðŸš€ Ejecutar servidor de desarrollo (Directo)"
    cmds:
      - poetry run python manage.py runserver 0.0.0.0:8000