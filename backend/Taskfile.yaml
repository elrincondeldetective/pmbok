# /webapps/erd-ecosystem/apps/pmbok/backend/Taskfile.yaml
version: '3'

# Variables de entorno por defecto para que Django arranque sin errores
env:
  # Forzamos modo DEBUG para evitar validaciones estrictas de seguridad en local
  DJANGO_DEBUG: "True"
  # Definimos una SECRET_KEY cualquiera para que settings.py no falle al arrancar
  SECRET_KEY: "insecure-test-key-for-task-runner"
  # Valores placeholder para la DB.
  # Aunque usemos SimpleTestCase, Django lee settings.py al inicio y necesita estos valores.
  # âœ… FIX: Alineado con docker-compose y la DB de CI para conectar a localhost
  DB_NAME: "pmbok_db"
  DB_USER: "pmbok_user"
  DB_PASSWORD: "secretpassword123"
  DB_HOST: "localhost"
  DB_PORT: "5432"

tasks:
  install:
    desc: "ğŸ“¦ Instalar dependencias (Local)"
    cmds:
      - poetry install --no-root

  install-ci:
    desc: "ğŸ“¦ Instalar dependencias (CI - Strict)"
    cmds:
      # âœ… FIX: Usamos 'sync' en lugar de '--sync' para evitar el warning de deprecaciÃ³n
      - poetry sync --no-root

  test:
    desc: "ğŸ§ª Ejecutar pruebas unitarias (Pytest)"
    # âœ… FIX: Aseguramos que haya una DB escuchando antes de correr los tests
    deps: [db:ensure]
    cmds:
      - echo "ğŸ§ª [BACKEND] Ejecutando tests..."
      - poetry run pytest

  # âœ… NEW: Tarea inteligente para levantar DB solo si hace falta
  db:ensure:
    desc: "Levanta una DB efÃ­mera si el puerto 5432 estÃ¡ libre"
    cmds:
      - |
        # Verificamos si algo ya escucha en el puerto 5432 (usando bash tcp check)
        if ! (echo > /dev/tcp/localhost/5432) >/dev/null 2>&1; then
          echo "ğŸ˜ [CI] No se detectÃ³ DB en el puerto 5432. Levantando contenedor temporal 'pmbok-ci-db'..."
          
          # Intentamos limpiar por si quedÃ³ una instancia zombie
          docker rm -f pmbok-ci-db >/dev/null 2>&1 || true
          
          # Levantamos Postgres ligero
          docker run -d --name pmbok-ci-db -p 5432:5432 \
            -e POSTGRES_DB=pmbok_db \
            -e POSTGRES_USER=pmbok_user \
            -e POSTGRES_PASSWORD=secretpassword123 \
            postgres:16-alpine
          
          echo "â³ [CI] Esperando a que Postgres estÃ© listo..."
          # Loop de espera hasta que pg_isready diga OK
          for i in {1..30}; do
            if docker exec pmbok-ci-db pg_isready -U pmbok_user -d pmbok_db >/dev/null 2>&1; then
              echo "âœ… DB lista para tests."
              break
            fi
            sleep 1
          done
        else
          echo "ğŸ˜ [CI] DB detectada en puerto 5432. UsÃ¡ndola."
        fi

  # âœ… NEW: EstandarizaciÃ³n de Linting
  lint:
    desc: "ğŸ§¹ Check de cÃ³digo (Flake8/Black)"
    cmds:
      - echo "ğŸ§¹ [BACKEND] Linting..."
      # Descomentar cuando configures linters:
      # - poetry run flake8 .
      # - poetry run black --check .

  # âœ… NEW: EstandarizaciÃ³n de Formateo
  fmt:
    desc: "ğŸ¨ Formatear cÃ³digo (Auto-fix)"
    cmds:
      - echo "ğŸ¨ [BACKEND] Formatting..."
      # - poetry run black .

  run:
    desc: "ğŸš€ Ejecutar servidor de desarrollo (Directo)"
    cmds:
      - poetry run python manage.py runserver 0.0.0.0:8000