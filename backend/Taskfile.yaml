# /webapps/erd-ecosystem/apps/pmbok/backend/Taskfile.yaml
version: '3'

# Variables de entorno por defecto para que Django arranque sin errores
env:
  # Forzamos modo DEBUG para evitar validaciones estrictas de seguridad en local
  DJANGO_DEBUG: "True"
  # Definimos una SECRET_KEY cualquiera para que settings.py no falle al arrancar
  SECRET_KEY: "insecure-test-key-for-task-runner"
  # Valores placeholder para la DB.
  # Aunque usemos SimpleTestCase, Django lee settings.py al inicio y necesita estos valores.
  # âœ… FIX: Alineado con docker-compose y la DB de CI para conectar a localhost
  DB_NAME: "pmbok_db"
  DB_USER: "pmbok_user"
  DB_PASSWORD: "secretpassword123"
  DB_HOST: "localhost"
  DB_PORT: "5432"

tasks:
  install:
    desc: "ğŸ“¦ Instalar dependencias (Local)"
    cmds:
      - poetry install --no-root

  install-ci:
    desc: "ğŸ“¦ Instalar dependencias (CI - Strict)"
    cmds:
      # âœ… FIX: Usamos 'sync' en lugar de '--sync' para evitar el warning de deprecaciÃ³n
      - poetry sync --no-root

  test:
    desc: "ğŸ§ª Ejecutar pruebas unitarias (Pytest) con Puerto DinÃ¡mico"
    # Aseguramos que la DB de CI estÃ© levantada antes de probar
    deps: [db:ensure]
    cmds:
      - |
        # 1. Obtener el puerto real asignado por Docker (Mapping dinÃ¡mico)
        CI_PORT=$(docker port pmbok-ci-db 5432/tcp | awk -F: '{print $2}')
        echo "ğŸ§ª [CI] Ejecutando tests contra DB en localhost:$CI_PORT"

        # 2. Configurar limpieza automÃ¡tica (Trap) para que corra pase lo que pase
        cleanup() {
            echo "ğŸ§¹ [CI] Limpiando contenedor de pruebas..."
            task db:cleanup
        }
        trap cleanup EXIT

        # 3. Ejecutar Pytest inyectando el PUERTO DINÃMICO (Sobreescribe el 5432 del env global)
        echo "ğŸ§ª [BACKEND] Iniciando Pytest..."
        DB_PORT=$CI_PORT poetry run pytest

  # âœ… NEW: Tarea inteligente y NO DESTRUCTIVA para levantar DB
  db:ensure:
    desc: "Levanta una DB efÃ­mera en puerto ALEATORIO (No mata tu entorno local)"
    cmds:
      - |
        # 1. Chequeo de Salud RÃ¡pido
        if docker exec pmbok-ci-db pg_isready -U pmbok_user -d pmbok_db >/dev/null 2>&1; then
            echo "ğŸ˜ [CI] La DB 'pmbok-ci-db' ya estÃ¡ lista. Reusando."
            exit 0
        fi

        # 2. Limpieza SOLO de la instancia de CI (No tocamos pmbok-db de Compose)
        docker rm -f pmbok-ci-db >/dev/null 2>&1 || true
        
        # 3. Arrancar nueva instancia con PUERTO DINÃMICO (-p 0:5432)
        # Esto evita el conflicto "Address already in use" con tu entorno local
        echo "ğŸ˜ [CI] Levantando 'pmbok-ci-db' en puerto dinÃ¡mico..."
        docker run -d --name pmbok-ci-db -p 0:5432 \
            -e POSTGRES_DB=pmbok_db \
            -e POSTGRES_USER=pmbok_user \
            -e POSTGRES_PASSWORD=secretpassword123 \
            postgres:16-alpine
          
        echo "â³ [CI] Esperando a que Postgres estÃ© listo..."
        for i in {1..30}; do
            if docker exec pmbok-ci-db pg_isready -U pmbok_user -d pmbok_db >/dev/null 2>&1; then
              echo "âœ… DB lista para tests."
              exit 0
            fi
            sleep 1
        done
        echo "âŒ Timeout esperando DB."
        exit 1

  # âœ… NEW: Tarea explÃ­cita de limpieza
  db:cleanup:
    desc: "Elimina el contenedor de base de datos de CI"
    cmds:
      - docker rm -f pmbok-ci-db >/dev/null 2>&1 || true

  # âœ… NEW: EstandarizaciÃ³n de Linting
  lint:
    desc: "ğŸ§¹ Check de cÃ³digo (Flake8/Black)"
    cmds:
      - echo "ğŸ§¹ [BACKEND] Linting..."
      # Descomentar cuando configures linters:
      # - poetry run flake8 .
      # - poetry run black --check .

  # âœ… NEW: EstandarizaciÃ³n de Formateo
  fmt:
    desc: "ğŸ¨ Formatear cÃ³digo (Auto-fix)"
    cmds:
      - echo "ğŸ¨ [BACKEND] Formatting..."
      # - poetry run black .

  run:
    desc: "ğŸš€ Ejecutar servidor de desarrollo (Directo)"
    cmds:
      - poetry run python manage.py runserver 0.0.0.0:8000