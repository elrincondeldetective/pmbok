# docker-compose.dev-backend-https.yml
services:
  backend-dev:
    container_name: pmbok_backend_dev_https

    # Publica SOLO el backend TLS en el host 8444
    # (el mapeo 8000 del compose base puede seguir apareciendo; si quieres ocultarlo, dime y lo movemos a otro override)
    ports:
      - "8444:8444"

    # Certificados self-signed para dev
    volumes:
      - ./certs:/certs:ro,Z

    # Ejecuta Gunicorn en HTTPS (8444)
    command: >
      gunicorn core.wsgi:application
      --bind 0.0.0.0:8444
      --workers 3
      --timeout 120
      --certfile /certs/dev.crt
      --keyfile /certs/dev.key

    # Healthcheck sin curl (usa Python) y tolerante a 404
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport ssl, urllib.request, urllib.error, sys\nctx=ssl._create_unverified_context()\nfor p in ('/healthz','/api/version','/'):\n  try:\n    urllib.request.urlopen('https://127.0.0.1:8444'+p, context=ctx, timeout=5)\n    sys.exit(0)\n  except urllib.error.HTTPError as e:\n    if 400 <= e.code < 500:\n      sys.exit(0)\n  except Exception:\n    pass\nsys.exit(1)\nPY",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 90s
