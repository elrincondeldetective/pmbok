# docker-compose.staging.yml (STAGING base)
services:
  db-staging:
    image: postgres:15-alpine
    profiles: ["staging"]
    volumes:
      - postgres_data_staging:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=pmbok_db
      - POSTGRES_USER=pmbok_user
      - POSTGRES_PASSWORD=pmbok_password
    # No expongas puertos aquÃ­ (evita choques con dev)
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h 127.0.0.1 -p 5432",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  backend-staging:
    profiles: ["staging"]
    build: ./backend
    command: gunicorn core.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120
    environment:
      - DJANGO_DEBUG=True
      - SECRET_KEY=una-clave-secreta-muy-fuerte-y-diferente...
      - DB_NAME=pmbok_db
      - DB_USER=pmbok_user
      - DB_PASSWORD=pmbok_password
      - DB_HOST=db-staging # ðŸ‘ˆ apunta al DB de staging
      - DB_PORT=5432
      - DB_SSLMODE=disable
      - RUN_SEED=auto
      - EXTRA_ALLOWED_HOSTS=backend-staging,localhost,127.0.0.1,0.0.0.0
    depends_on:
      db-staging:
        condition: service_healthy # espera a que Postgres estÃ© listo
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8000/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    # No exponemos puertos aquÃ­; lo definen los overrides http/https
    restart: unless-stopped

  frontend-staging:
    profiles: ["staging"]
    build:
      context: ./frontend
      dockerfile: Dockerfile.staging
      args:
        # API interna por la red de Docker (sin CORS)
        VITE_API_URL: http://backend-staging:8000/api
    # Puertos/SSL se definen en docker-compose.staging-http.yml / ...-https.yml
    depends_on:
      backend-staging:
        condition: service_started
    restart: unless-stopped

volumes:
  postgres_data_staging:
